<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.w3.org/1999/xhtml"
	  layout:decorate="~{_layout/seller/index}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<th:block layout:fragment="pageContent">
	<main id="main" class="main">
		<div class="container-fluid px-4">
			<h1 class="mt-4">미결제 확인</h1>
			<div class="card mb-4">
				<div class="card-body">
					<div class="card-body">구매자가 무통장입금/패밀리결제 또는 원천사 점검/장애 등으로 결제/입금이 완료되지 않은 주문 건을 확인하실 수 있습니다.</div>
					<ul>
						<li>구매자명(수취인명)의 연락처나 배송지 등 정보는 표시되지 않으며, 입금/결제가 완료되면 [발주(주문)확인/발송관리]메뉴에 신규 주문건으로 표시되어 모든 정보를 확인할 수 있습니다.</li>
						<li>무통장입금으로 결제한 경우 주문일로부터 2영업일 내에 결제 완료되지 않을 경우 주문은 자동으로 취소됩니다.</li>
						<li>원천사 점검/장애 등으로 결제한 경우 주문일시로부터 최대 1~2시간내 결제 완료되지 않을 경우 주문은 자동으로 취소됩니다.</li>
					</ul>
				</div>
			</div>
			<div class="card mb-4">
				<div class="card-header d-flex">
					<i class="fas fa-table me-1">
						목록 (총<span th:text="${orderitem.size()}"></span> 개)
					</i>
					<div style="margin-left:auto;">
						<button type="button" class="btn btn-info btn-sm btn-no-radius" id="downloadExcel" style="margin-left:5px;">엑셀 다운로드</button>
					</div>
				</div>
				<div class="card-body">
					<table id="datatablesSimple" class="table table-striped">
						<thead>
						<tr>
							<th style="width:10%;">상품주문번호</th>
							<th style="width:10%;">통합주문번호</th>
							<th>주문일시</th>
							<th>구매자명</th>
							<th>구매자ID</th>
							<th>상품코드</th>
							<th>상품명</th>
							<th>결제상태</th>
						</tr>
						</thead>
						<tbody>
						<!-- Thymeleaf 코드로 상품 목록을 반복하여 출력합니다 -->
						<tr th:each="o, stat : ${orderitem}" id="orderlist" class="orderitem-row"
							th:data-orderitem-id="${o.orderitemId}">
							<td th:text="${o.orderitemId}"></td>
							<td th:text="${o.orderlist.orderlistId}"></td>
							<td th:text="${o.orderlist.orderlistDate}"></td>
							<td th:text="${o.orderlist.buyer.buyerName}"></td>
							<td th:text="${o.orderlist.buyer.buyerId}"></td>
							<td th:text="${o.product.productCode}"></td>
							<td th:text="${o.product.productName}"></td>
							<td th:text="${o.orderitemPstatus}"></td>
						</tr>
						</tbody>

					</table>
				</div>
			</div>
		</div>
	</main>
	!--테이블 엑셀 다운로드-->
	<script>
		document.getElementById('downloadExcel').addEventListener('click', function() {
            // 현재 페이지 데이터 수집
            var tableRows = document.querySelectorAll('#datatablesSimple tbody tr');
            var rowData = Array.from(tableRows).map(function(row) {
                return {
                    orderitemId: row.cells[0].innerText,
                    orderlistId: row.cells[1].innerText,
                    orderlistDate: row.cells[2].innerText,
                    buyerName: row.cells[3].innerText,
                    buyerId: row.cells[4].innerText,
                    productCode: row.cells[5].innerText,
                    productName: row.cells[6].innerText,
                    orderitemPstatus: row.cells[7].innerText
                };
            });

            // 서버로 데이터 전송
            fetch('/api/outstanding/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(rowData)
            })
            .then(response => response.blob())
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;

                // 파일명에 오늘 날짜를 포함시킴
				const today = new Date();
				const formattedDate = today.toISOString().split('T')[0];
				const fileName = formattedDate + " 미결제.xlsx";

                a.download = fileName;
                document.body.appendChild(a); // Firefox에서 필요
                a.click();
                a.remove();
            })
            .catch(error => console.error('Error downloading the file:', error));
        });
	</script>
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			var datatablesSimple = document.getElementById('datatablesSimple');
			if (datatablesSimple) {
				new simpleDatatables.DataTable(datatablesSimple);
			}
		});
	</script>
</th:block>
</html>
