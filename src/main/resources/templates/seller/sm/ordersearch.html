<!DOCTYPE html>
<html layout:decorate="~{_layout/seller/index}">
<!--
<th:block layout:fragment="pageHead">
    <title th:text="${pageName}"></title>
</th:block>
-->
<th:block layout:fragment="pageContent">
	<main id="main" class="main">
		<section>
			<div class="container-fluid px-4">
				<h1 class="mt-4">주문통합검색</h1>
				<section class="section dashboard">
					<div class="row">
						<div class="col-lg-12">
							<div class="row">
								<!-- Sales Card -->
								<div class="col-xxl-12 col-md-12">
									<div class="card info-card sales-card">
										<div class="card-body">
											<div>
												<h5 class="card-title fw-bold border-bottom" style="padding-top: 10px; margin-bottom:0px;">
													스마트스토어의 모든 주문건을 조회할 수 있는 통합 주문조회 메뉴입니다.
												</h5>
												<ul class="mb-3 mt-3" style="list-style-type:disc;">
													<li class="mb-1">주문조회 기간은 시작일~종료일을 최대 1년 범위로 조회가 가능하며, 상세조건을 설정하지 않은 경우 최대 1개월까지 조회 가능합니다.</li>
													<li class="mb-1">주문건을 선택하시면 주문목록 하단에 주문상태에 따라 처리 가능한 버튼이 활성화 됩니다.(클릭 시 관련 메뉴로 이동하여 주문건 처리 가능)</li>
													<li class="mb-1">해당 메뉴에서는 모든 상태의 주문건 조회만 가능하며, 주문확인/상품발송/클레임 처리는 대상 메뉴들에서 진행하실 수 있습니다.</li>
												</ul>
											</div>
										</div>
									</div>
								</div><!-- End Sales Card -->
							</div>
						</div>
					</div>
				</section>
				<div class="card mb-4 d-flex">
					<div class="card-body border-bottom">조회기간</div>
					<div class="card-body">
						<div class="d-flex">
							<div style="margin-right:10px;">
								<input type="radio" id="now" name="now" value="1">
								<label class="btn btn-info btn-sm btn-no-radius"
									   for="now" onclick="printValue('1')">
									오늘
								</label>
								<input type="radio" id="week" name="week" value="2">
								<label class="btn btn-info btn-sm btn-no-radius"
									   for="week" onclick="printValue('2')">
									1주일
								</label>
								<input type="radio" id="1month" name="1month" value="3">
								<label class="btn btn-info btn-sm btn-no-radius"
									   for="1month" onclick="printValue('3')">
									1개월
								</label>
								<input type="radio" id="3month" name="3month" value="4">
								<label class="btn btn-info btn-sm btn-no-radius"
									   for="3month" onclick="printValue('4')">
									3개월
								</label>
							</div>
							<label for="lastdate" class="d-flex align-items-center">
								<input type="date"
									   id="lastdate"
									   max="2040-12-31"
									   min="2010-01-01">
							</label>
							<label for="nowdate" class="d-flex align-items-center">  ~
								<input type="date"
									   id="nowdate"
									   max="2040-12-31"
									   min="2010-01-01">
							</label>
						</div>
					</div>
					<div>
						<button type="button" class="btn" id="search">검색</button>
					</div>
				</div>
				<div class="card mb-4" id="listtable">
					<div class="card-header d-flex">
						<i class="fas fa-table me-1">
							목록 (총<span th:text="${privateorder.size()}"></span> 개)
						</i>
						<div style="margin-left:auto;">
							<button type="button" class="btn btn-info btn-sm btn-no-radius" id="downloadExcel" style="margin-left:5px;">엑셀 다운로드</button>
						</div>
					</div>
					<div class="card-body">
						<table id="datatablesSimple" class="table table-striped">
							<thead>
							<tr>
								<th style="width:5%;">목록</th>
								<th style="width:8%;">상품주문번호</th>
								<th>상품코드</th>
								<th>상품명</th>
								<th>개수</th>
								<th>가격</th>
								<th>주문일시</th>
								<th>주문상태</th>
								<th>배송상태</th>
								<th>처리상태</th>
							</tr>
							</thead>
							<tbody>
								<!-- Thymeleaf 코드로 상품 목록을 반복하여 출력합니다 -->
								<tr th:each="o, stat : ${privateorder}" id="orderlist" class="orderitem-row"
									th:data-orderitem-id="${o.orderitemId}">
									<td th:text="${stat.count}"></td>
									<td th:text="${o.orderlist.orderlistId}"></td>
									<td th:text="${o.product.productCode}"></td>
									<td th:text="${o.product.productName}"></td>
									<td th:text="${o.orderitemPcount}"></td>
									<td th:text="${o.product.productPrice}"></td>
									<td th:text="${o.orderlist.orderlistDate}"></td>
									<td th:text="${o.orderitemPstatus}"></td>
									<td th:text="${o.orderitemDstatus}"></td>
									<td th:text="${o.orderitemCase}"></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</section>
	</main><!-- End #main -->
	<!--버튼 누르면 날짜 계산기능-->
	<script>
		function printValue(selectedValue) {
            var currentDate = new Date();
            var year, month, day, formattedDate;

            if (selectedValue === "1") {
                year = currentDate.getFullYear();
                month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                day = currentDate.getDate().toString().padStart(2, '0');
                formattedDate = `${year}-${month}-${day}`;
            } else if (selectedValue === "2") {
                currentDate.setDate(currentDate.getDate() - 7);
                year = currentDate.getFullYear();
                month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                day = currentDate.getDate().toString().padStart(2, '0');
                formattedDate = `${year}-${month}-${day}`;
            } else if (selectedValue === "3") {
                currentDate.setMonth(currentDate.getMonth() - 1);
                year = currentDate.getFullYear();
                month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                day = currentDate.getDate().toString().padStart(2, '0');
                formattedDate = `${year}-${month}-${day}`;
            } else if (selectedValue === "4") {
                currentDate.setMonth(currentDate.getMonth() - 3);
                year = currentDate.getFullYear();
                month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
                day = currentDate.getDate().toString().padStart(2, '0');
                formattedDate = `${year}-${month}-${day}`;
            }

            document.getElementById("lastdate").value = formattedDate;

            var radios = document.querySelectorAll('input[type="radio"]');
            radios.forEach(function(radio) {
                if (radio.value !== selectedValue) {
                    radio.checked = false;
                }
            });
        }
	</script>
	<!--nowdate 오늘날짜 자동출력-->
	<script>
		function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        const today = new Date();
        const formattedToday = formatDate(today);

        document.getElementById('nowdate').value = formattedToday;
	</script>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
            // DOM이 완전히 로드된 후에 실행됩니다.
            var weekRadio = document.getElementById('week');
            if (!weekRadio.checked) {
                weekRadio.checked = true;
                printValue('2');
            }

            // simple-datatables를 사용하여 테이블 초기화
            var table = new simpleDatatables.DataTable('#datatablesSimple', {
                searchable: true, // 검색 기능 활성화
                pagination: true // 페이징 처리 활성화
            });

            // 검색 버튼 클릭 시 동작
            document.getElementById('search').addEventListener('click', function() {
                var startDate = document.getElementById('lastdate').value;
                var endDate = document.getElementById('nowdate').value;

                console.log(startDate);
                console.log(endDate);

                fetch('http://localhost:8010/seller/cm/ordersearch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ startDate: startDate, endDate: endDate }),
                })
                .then(response => response.text())
                .then(html => {
                    console.log("새로운 날짜 범위로 상품 목록을 가져옵니다.");

                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');
                    var productData = Array.from(doc.querySelectorAll('tbody tr'));

                    // 테이블 데이터 갱신
                    table.destroy(); // 기존 테이블 제거
                    var tbody = document.querySelector('tbody');
                    tbody.innerHTML = ''; // 테이블 데이터 초기화
                    var itemCount = 0;
                    productData.forEach(function(item) {
                        var orderDate = item.querySelector('td:nth-child(6)').textContent;
                        if (orderDate >= startDate && orderDate <= endDate) {
                            tbody.appendChild(item.cloneNode(true));
                            itemCount++;
                        }
                    });

                    // 새로운 DataTables 객체 생성
                    table = new simpleDatatables.DataTable('#datatablesSimple', {
                        searchable: true, // 검색 기능 활성화
                        pagination: true // 페이징 처리 활성화
                    });

                    // 목록 개수 업데이트
                    var itemCountSpan = document.querySelector('.card-header i span');
                    itemCountSpan.textContent = itemCount;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
	</script>

	<!--테이블 엑셀 다운로드-->
	<script>
		document.getElementById('downloadExcel').addEventListener('click', function() {
            // 현재 페이지 데이터 수집
            var tableRows = document.querySelectorAll('#datatablesSimple tbody tr');
            var rowData = Array.from(tableRows).map(function(row) {
                return {
                    orderlistId: row.cells[1].innerText,
                    productCode: row.cells[2].innerText,
                    productName: row.cells[3].innerText,
                    orderitemPcount: row.cells[4].innerText,
                    productPrice: row.cells[5].innerText,
                    orderlistDate: row.cells[6].innerText,
                    orderitemPstatus: row.cells[7].innerText,
                    orderitemDstatus: row.cells[8].innerText,
                    orderitemCase: row.cells[9].innerText
                };
            });

            // 서버로 데이터 전송
            fetch('/api/ordersearch/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(rowData)
            })
            .then(response => response.blob())
            .then(blob => {
                var url = window.URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;

                // 파일명에 오늘 날짜를 포함시킴
				const today = new Date();
				const formattedDate = today.toISOString().split('T')[0];
				const fileName = formattedDate + " 주문통합.xlsx";

                a.download = fileName;
                document.body.appendChild(a); // Firefox에서 필요
                a.click();
                a.remove();
            })
            .catch(error => console.error('Error downloading the file:', error));
        });
	</script>

	<style>
		input[type="radio"] {
            display: none;
        }
        input[type="radio"]:checked + label {
            background-color: rgb(13, 110, 253);
        }
        .btn {
            border-radius: 0 !important;
        }
	</style>
</th:block>
</html>

